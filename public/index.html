<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>zoom2srt | Unofficial zoom chat to subtitle converter</title>

    <link rel="stylesheet" href="style.css" type="text/css" media="screen" />
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="apple-touch-icon.png" />
    <script type="text/javascript" src="script.js"></script>
    <script type="text/javascript">
      let rawChat = "";
      function gatherOpts() {
        const pad2 = (s) => s.toString().padStart(2, "0");
        const duration = document.getElementById("duration").value;
        const nickStyle = document.querySelector(
          'input[name="style"]:checked',
        ).value;
        const minutes = pad2(document.getElementById("minutes").value);
        const seconds = pad2(document.getElementById("seconds").value);
        return {
          duration: parseInt(duration),
          nickStyle: nickStyle,
          offset: `00:${minutes}:${seconds}`,
        };
      }
      function updatePreview() {
        const previewSub = (sub) => sub.split("\n\n").slice(0, 2).join("\n\n");
        document.getElementById("settings").style.display = null;
        document.getElementById("upload").style.display = "none";
        const containerDiv = document.getElementById("platform");
        const finalSubs = processChat(rawChat, gatherOpts());
        /* containerDiv.innerText = previewSub(finalSubs); */
      }
      function clickDownload() {
        const downloadAnchor = document.createElement("a");
        downloadAnchor.setAttribute("download", "subtitle.srt"); // TODO: get a proper filename
        downloadAnchor.setAttribute(
          "href",
          "data:text/plain;charset=utf-8," +
            encodeURIComponent(processChat(rawChat, gatherOpts())),
        );
        downloadAnchor.style.display = "none";
        document.body.appendChild(downloadAnchor);
        downloadAnchor.click();
        document.body.removeChild(downloadAnchor);
      }
      function loadChat() {
        const [chatfile] = document.getElementById("chatfile").files;
        const reader = new FileReader();
        reader.addEventListener(
          "load",
          () => {
            rawChat = reader.result;
            updatePreview();
          },
          false,
        );
        if (chatfile) reader.readAsText(chatfile);
      }
    </script>
  </head>
  <body>
    <header>
      <h1>zoom2srt</h1>
    </header>
    <main>
      <div id="upload">
        <fieldset>
          <legend>Select a Zoom .txt chat file to upload</legend>
          <input
            type="file"
            id="chatfile"
            name="chatfile"
            accept=".txt"
            onchange="loadChat()"
          />
        </fieldset>
      </div>
      <div id="platform"></div>
      <div id="settings" style="display: none">
        <fieldset>
          <legend title="Style to apply to message nicknames">
            Nick style
          </legend>
          <input type="radio" name="style" id="none" value="none" checked />
          <label for="colors">none</label>
          <input type="radio" name="style" id="colors" value="colors" />
          <label for="colors" title="A different color for each nick"
            >colorized</label
          >
          <input type="radio" name="style" id="bold" value="bold" />
          <label for="colors">bold</label>
        </fieldset>
        <fieldset>
          <legend title="How long each chat message stays on-screen">
            Message duration
          </legend>
          <input
            type="number"
            name="duration"
            id="duration"
            min="1"
            max="99"
            value="5"
            required
          />
          <label for="duration">seconds </label>
        </fieldset>
        <fieldset>
          <legend
            title="For when some of the beginning of the video has been cut out"
          >
            Start time offset
          </legend>
          <input
            type="number"
            name="minutes"
            id="minutes"
            min="0"
            max="59"
            value="0"
          />
          <label for="minutes">minutes</label>
          <input
            type="number"
            name="seconds"
            id="seconds"
            min="0"
            max="59"
            value="0"
          />
          <label for="seconds">seconds</label>
        </fieldset>
        <button id="download" onclick="clickDownload()">Download!</button>
      </div>
    </main>
    <footer>Copyright © 2024 azimut ― All rights reserved.</footer>
  </body>
</html>
